#!/bin/bash

# Function to set up kubeconfig for a specified user
function setup_kubeconfig_for_user() {
  local user_name=$1
  local user_home=$2
  local override_file_name=${3:-"admin.conf"}

  mkdir -p "${user_home}/.kube"
  cp /etc/kubernetes/${override_file_name} "${user_home}/.kube/config"
  chown "${user_name}:${user_name}" "${user_home}/.kube/config"
}

# Function to finalize the setup for a specified user
finalize_k8s_setup_for_user() {
  local user_name=$1
  local user_home=$2

  # Ensure the .kube directory exists
  mkdir -p "${user_home}/.kube"

  # Generate the kubectl completion script
  local completion_file="${user_home}/.kube/completion.bash.inc"
  kubectl completion bash > "$completion_file"

  # Source the completion script in the user's .bash_profile if not already sourced
  local source_string="source '$completion_file'"
  if ! grep -qF "$source_string" "${user_home}/.bash_profile"; then
    printf "\n# kubectl shell completion\n$source_string\n" >> "${user_home}/.bash_profile"
  fi
}